# --- Conditional Processing ---
# Only execute following steps if Google Calendar data has changed.
# (Skip when HTTP status is 304)

name: JP-Holiday Calendar generate

on:
  push:
    branches: [ "master" ]               # Trigger on pushes to master
  schedule:
    - cron: '0 0 * * *'                  # Run every day at 00:00 (UTC)
  workflow_dispatch:                     # Allow manual triggering

# Prevent multiple concurrent deployments from overlapping
concurrency:
  group: "pages"
  cancel-in-progress: true

permissions:
  contents: write                        # Allow pushing changes (e.g., .exec_timestamp updates)

jobs:
  # ----------------------------
  # Build Job
  # ----------------------------

  build:
    runs-on: ubuntu-latest
    outputs:
      # Export main.php result status for deploy job
      status: ${{ steps.main.outputs.status }}
      hash: ${{ steps.main.outputs.new_hash }}

    steps:
      # ----------------------------
      # Setup and Dependency Management
      # ----------------------------

      # Check out the repository code
      - uses: actions/checkout@v4

      # Composer validation
      - name: Validate composer.json and composer.lock
        run: composer validate --strict
        continue-on-error: true            # Continue even if validation warnings occur

      # Cache Composer dependencies to speed up future runs.
      # On first execution, no cache is found and vendor/ will be created by Composer.
      # On subsequent runs, the cache restores vendor/ before installation,
      # allowing Composer to reuse packages without re-downloading.
      # The cache is automatically saved at the end of the job when a miss occurs.
      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: php-composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            php-composer-${{ runner.os }}-

      # Install PHP dependencies using Composer.
      # Thanks to the cache step above, this command completes quickly
      # when dependencies are already up to date.
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      # Make need directory
      - name: Make directory
        run: |
          mkdir -p ./dist                  # Output directory for generated files
          mkdir -p ./.cache                # Cache directory for Google Calendar data

      # ----------------------------
      # Google Calendar Caching
      # ----------------------------

      # Determine the current cache hash before execution.
      # Reads the latest SHA256 hash from the .cache directory if available;
      # otherwise falls back to "nohash" for initial runs.
      # This ensures that the restore key reflects the exact Google Calendar data state
      # and avoids unnecessary re-fetching or redundant cache generations.
      - name: Get Hash of Cache
        id: hashcheck
        run: |
          HASH=$( [ -f .cache/gcal_raw.sha256 ] && cat .cache/gcal_raw.sha256 | tr -d '\n' || echo "nohash" )
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Current cache hash: $HASH"

      # Restore cached calendar data from previous builds.
      # The key uses run_id for uniqueness on save but only restore-keys for lookup.
      # This avoids creating redundant “gcal-cache-{Linux}” entries.
      - name: Restore calendar cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: gcal-cache-${{ runner.os }}-${{ steps.hashcheck.outputs.hash }}
          restore-keys: |
            gcal-cache-${{ runner.os }}-

      # ----------------------------
      # Main Script Execution
      # ----------------------------

      # Execute the main PHP script responsible for fetching and processing
      # the latest Google Calendar data. The script generates a result log
      # that includes the HTTP response status and an updated SHA256 hash
      # of the retrieved calendar content.
      # The HTTP status (e.g., 200 or 304) and new hash are extracted and
      # exported as GitHub Action outputs for conditional steps downstream.
      # This allows subsequent jobs to determine whether to skip or update
      # deployment based on content changes.
      - name: Run main
        id: main
        run: |
          php ./main.php > result.log
          STATUS=$(grep -o '"status":[[:space:]]*[0-9]\+' result.log | head -1 | grep -o '[0-9]\+')
          NEW_HASH=$(cat .cache/gcal_raw.sha256 | tr -d '\n')
          echo "status=$STATUS" >> $GITHUB_OUTPUT       # Pass status to later steps
          echo "new_hash=$NEW_HASH" >> $GITHUB_OUTPUT   # Pass hash to later steps
          echo "main.php finished with status [$STATUS]"
          rm -f result.log

      # ----------------------------
      # Conditional Processing (Only when Calendar Updated)
      # ----------------------------

      # Save updated cache only when calendar data changed.
      # Keeps cache fresh without redundant data writes.
      - name: Save calendar cache
        if: steps.main.outputs.status != '304'
        uses: actions/cache@v4
        with:
          path: .cache
          key: gcal-cache-${{ runner.os }}-${{ steps.main.outputs.new_hash }}

      # Ensure README.md exists before converting and copy for pandoc
      - name: Ensure README.md exists
        if: steps.main.outputs.status != '304'
        run: test -f README.md && cp README.md index.md

      # Convert README.md to index.html for GitHub Pages
      # Using official Pandoc Docker image for reproducibility
      # Adds SEO-friendly metadata, OGP tags, and Twitter Card integration
      - name: Generate index.html by Pandoc
        if: steps.main.outputs.status != '304'
        uses: docker://pandoc/core
        with:
          args: >
            -f markdown
            -t html5
            index.md
            -s
            --embed-resources
            -c github-markdown-dark.css
            --metadata title="Japanese Holiday🎉"
            --variable=titleblock:false
            --include-in-header=meta.html
            -o dist/index.html

      # Force remove Pandoc title header block
      - name: Remove Pandoc title header block
        if: steps.main.outputs.status != '304'
        # Deletes the `<header id="title-block-header">...</header>` block
        run: sed -i '/<header id="title-block-header">/,/<\/header>/d' dist/index.html

      # Copy resources
      - name: Copy resources
        if: steps.main.outputs.status != '304'
        run: |
          cp ./googleb95e7dd5d4aa5997.html ./dist/
          cp ./ogp.png ./dist/

      # Commit timestamp and push changes only if calendar was updated
      # Note: .exec_timestamp is always updated intentionally for tracking
      - name: git Commit & Push
        if: steps.main.outputs.status != '304'
        run: |
          date -u +%FT%TZ > .exec_timestamp
          git config core.filemode false
            if ! git diff --exit-code --quiet
            then
              git add --update
              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
              git commit -m "[Update] Auto-Commit by github-actions $(date -u +%F)" || echo "No changes to commit"
              git push
            fi

      # Clean up temporary files
      - name: Cleanup temporary files
        if: steps.main.outputs.status != '304'
        run: |
          rm -f index.md

      # Upload artifacts for GitHub Pages deployment
      - name: Upload Pages artifact
        if: steps.main.outputs.status != '304' && hashFiles('dist/**') != ''
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  # ----------------------------
  # Deploy Job (only if updated)
  # ----------------------------

  deploy:
    runs-on: ubuntu-latest
    needs: build

    # Take over the build job's output status and skip when 304 (no data change)
    if: ${{ needs.build.outputs.status != '304' }}
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Publish URL to summary
        run: echo "Deployed to ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
